<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Production & Dispatch Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Heroicons (for icons, inlined as SVG where needed) -->
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .card-header { background-color: #FF7A00; color: white; }
        .editable { cursor: pointer; font-family: monospace; }
        .error { border-color: red; }
        th.sticky { position: sticky; top: 0; background: white; z-index: 10; }
        /* Sparkline placeholder styles (optional, using simple div) */
        .sparkline { width: 100px; height: 20px; background: linear-gradient(to right, #ddd, #aaa); }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Title -->
        <h1 class="text-2xl font-bold text-center mb-4">Daily Production & Dispatch Dashboard — Date: <span id="dashboard-date">01-11-2025</span></h1>
        
        <!-- Top Action Bar -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
                <label for="date-input" class="mr-2">Date:</label>
                <input type="text" id="date-input" value="01-11-2025" class="border rounded p-1" onchange="updateDate(this.value)">
            </div>
            <div class="flex space-x-2 mt-2 md:mt-0">
                <button onclick="exportCSV()" class="bg-blue-500 text-white px-4 py-2 rounded">Export CSV</button>
                <button onclick="exportExcel()" class="bg-green-500 text-white px-4 py-2 rounded">Export Excel</button>
                <button onclick="printDashboard()" class="bg-gray-500 text-white px-4 py-2 rounded">Print</button>
            </div>
        </div>
        
        <!-- Responsive Grid: 1 col mobile, 2 col desktop -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Section 1: Production Summary -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg" title="Summary of production metrics for the day and month.">Production Summary</h2>
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="border p-2 sticky">Metric</th>
                            <th class="border p-2 sticky" title="For The Day">FTD</th>
                            <th class="border p-2 sticky" title="Month To Date">MTD</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2">Mine Production</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Boulder Dispatch QTY</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Plant Production</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Dispatch QTY</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Basic Revenue</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Total Revenue</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Section 2: Royalty Requirement & Dispatch Planning -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg" title="Royalty balances and planning for materials.">Royalty Requirement & Dispatch Planning</h2>
                <table class="w-full border-collapse" id="royalty-table">
                    <thead>
                        <tr>
                            <th class="border p-2 sticky">Materiel</th>
                            <th class="border p-2 sticky" title="10MM material">10MM</th>
                            <th class="border p-2 sticky" title="20MM material">20MM</th>
                            <th class="border p-2 sticky" title="40MM material">40MM</th>
                            <th class="border p-2 sticky" title="40-65MM material">40–65MM</th>
                            <th class="border p-2 sticky" title="Msand material">Msand</th>
                            <th class="border p-2 sticky" title="GSB material">GSB</th>
                            <th class="border p-2 sticky">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2">Royalty Balance in MDL (Tons)</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">7.5</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">12.4</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">1</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">167</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2 font-bold" id="royalty-total">187.9</td> <!-- Pre-calculated -->
                        </tr>
                        <tr>
                            <td class="border p-2 font-bold" colspan="7">Grand Total</td>
                            <td class="border p-2 font-bold" id="royalty-grand-total">187.9</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Section 3: Today’s Dispatch Plan in Tons -->
            <div class="bg-white p-4 rounded-lg shadow md:col-span-2"> <!-- Span 2 cols on desktop -->
                <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg" title="Dispatch plan by customer and material.">Today’s Dispatch Plan in Tons</h2>
                <table class="w-full border-collapse" id="dispatch-table">
                    <thead>
                        <tr>
                            <th class="border p-2 sticky">Customer</th>
                            <th class="border p-2 sticky">10MM</th>
                            <th class="border p-2 sticky">20MM</th>
                            <th class="border p-2 sticky">40MM</th>
                            <th class="border p-2 sticky">40–65MM</th>
                            <th class="border p-2 sticky">Msand</th>
                            <th class="border p-2 sticky">GSB</th>
                            <th class="border p-2 sticky">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2">Aravind Techno</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                        <!-- Repeat for other customers -->
                        <tr>
                            <td class="border p-2">Chenderu & Co</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                        <tr>
                            <td class="border p-2">Afcon Projects</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                        <tr>
                            <td class="border p-2">KEC</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                        <tr>
                            <td class="border p-2">JS Mineing</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                        <tr>
                            <td class="border p-2">L&T – P1</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                        <tr>
                            <td class="border p-2">Others</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                        <tr>
                            <td class="border p-2 font-bold">Total</td>
                            <td class="border p-2 font-bold">0</td>
                            <td class="border p-2 font-bold">0</td>
                            <td class="border p-2 font-bold">0</td>
                            <td class="border p-2 font-bold">0</td>
                            <td class="border p-2 font-bold">0</td>
                            <td class="border p-2 font-bold">0</td>
                            <td class="border p-2 font-bold">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Section 4: Stock Status -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg" title="Current stock levels.">Stock Status</h2>
                <table class="w-full border-collapse">
                    <tbody>
                        <tr>
                            <td class="border p-2">10MM</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">20MM</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">RIVO</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">M-Sand</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Railway Ballast (40–65MM)</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2 font-bold">Total Stock</td>
                            <td class="border p-2 font-bold" id="stock-total">0</td>
                        </tr>
                        <tr>
                            <td class="border p-2">Boulder Stock at Quarry</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Boulder Stock at Plant</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Diesel Stock</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Tire Stock</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Section 5: Equipment Update -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg" title="Status of equipment.">Equipment Update</h2>
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="border p-2 sticky">Equipment</th>
                            <th class="border p-2 sticky">Running</th>
                            <th class="border p-2 sticky">Idle</th>
                            <th class="border p-2 sticky">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2">Tippers</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true"> </span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Excavators Working</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true"> </span></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Loaders Working</td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                            <td class="border p-2"><span class="editable" contenteditable="true"> </span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Section 6: Operational Performance Summary -->
            <div class="bg-white p-4 rounded-lg shadow md:col-span-2">
                <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg" title="Key performance indicators.">Operational Performance Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gray-100 p-4 rounded text-center">
                        <h3 class="font-bold">Total Trips of Tippers</h3>
                        <span class="text-2xl editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span>
                        <div class="sparkline mx-auto mt-2"></div>
                    </div>
                    <div class="bg-gray-100 p-4 rounded text-center">
                        <h3 class="font-bold">Total Tonnage Moved</h3>
                        <span class="text-2xl editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span>
                        <div class="sparkline mx-auto mt-2"></div>
                    </div>
                    <div class="bg-gray-100 p-4 rounded text-center">
                        <h3 class="font-bold">Excavator Working Hours</h3>
                        <span class="text-2xl editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span>
                        <div class="sparkline mx-auto mt-2"></div>
                    </div>
                    <div class="bg-gray-100 p-4 rounded text-center">
                        <h3 class="font-bold">Compressor Holes Drilled</h3>
                        <span class="text-2xl editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span>
                        <div class="sparkline mx-auto mt-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Section 7: Fund Requirement & Collection Plan -->
            <div class="bg-white p-4 rounded-lg shadow md:col-span-2">
                <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg" title="Financial planning for funds and collections.">Fund Requirement & Collection Plan</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold mb-2">Fund Requirement</h3>
                        <table class="w-full border-collapse" id="fund-requirement-table">
                            <thead>
                                <tr>
                                    <th class="border p-2">Vendor Name</th>
                                    <th class="border p-2">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Add rows dynamically or static; for example -->
                                <tr>
                                    <td class="border p-2"><span class="editable" contenteditable="true"></span></td>
                                    <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                                </tr>
                                <!-- Add more rows as needed, or use JS to add -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="border p-2 font-bold">Total Fund Requirement</td>
                                    <td class="border p-2 font-bold" id="fund-total">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">Expected Collection</h3>
                        <table class="w-full border-collapse" id="collection-table">
                            <thead>
                                <tr>
                                    <th class="border p-2">Customer Name</th>
                                    <th class="border p-2">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border p-2"><span class="editable" contenteditable="true"></span></td>
                                    <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)">0</span></td>
                                </tr>
                                <!-- Add more -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="border p-2 font-bold">Total Expected Collection</td>
                                    <td class="border p-2 font-bold" id="collection-total">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update date
        function updateDate(newDate) {
            document.getElementById('dashboard-date').textContent = newDate;
        }

        // Validate and update totals
        function validateAndUpdate(element) {
            const value = element.textContent.trim();
            if (element.dataset.type === 'number' && isNaN(parseFloat(value))) {
                element.classList.add('error');
                return;
            }
            element.classList.remove('error');
            updateTotals();
        }

        // Update all totals
        function updateTotals() {
            // Royalty Table
            const royaltyRow = document.querySelector('#royalty-table tbody tr');
            let royaltyTotal = 0;
            royaltyRow.querySelectorAll('.editable').forEach(cell => {
                const val = parseFloat(cell.textContent) || 0;
                royaltyTotal += val;
            });
            document.getElementById('royalty-total').textContent = royaltyTotal.toFixed(1);
            document.getElementById('royalty-grand-total').textContent = royaltyTotal.toFixed(1);

            // Dispatch Table
            const dispatchRows = document.querySelectorAll('#dispatch-table tbody tr:not(:last-child)');
            const columnTotals = Array(6).fill(0);
            let grandTotal = 0;
            dispatchRows.forEach(row => {
                let rowTotal = 0;
                const cells = row.querySelectorAll('.editable');
                cells.forEach((cell, idx) => {
                    const val = parseFloat(cell.textContent) || 0;
                    rowTotal += val;
                    columnTotals[idx] += val;
                });
                row.querySelector('td:last-child').textContent = rowTotal;
                grandTotal += rowTotal;
            });
            const totalRow = document.querySelector('#dispatch-table tbody tr:last-child');
            totalRow.querySelectorAll('td:not(:first-child):not(:last-child)').forEach((td, idx) => {
                td.textContent = columnTotals[idx];
            });
            totalRow.querySelector('td:last-child').textContent = grandTotal;

            // Stock Total
            let stockTotal = 0;
            document.querySelectorAll('[id="stock-total"]').forEach(total => {
                const stockRows = total.closest('table').querySelectorAll('tr:nth-child(-n+5) .editable'); // First 5 are materials
                stockTotal = Array.from(stockRows).reduce((sum, cell) => sum + (parseFloat(cell.textContent) || 0), 0);
                total.textContent = stockTotal;
            });

            // Fund and Collection Totals
            ['fund-requirement-table', 'collection-table'].forEach(id => {
                const table = document.getElementById(id);
                let total = 0;
                table.querySelectorAll('tbody .editable[data-type="number"]').forEach(cell => {
                    total += parseFloat(cell.textContent) || 0;
                });
                table.querySelector('tfoot td:last-child').textContent = total;
            });
        }

        // Export CSV
        function exportCSV() {
            let csv = 'Section,Data\n'; // Collect all data
            // Add logic to iterate through all tables and append to csv
            // For brevity, example for one table
            const tables = document.querySelectorAll('table');
            tables.forEach((table, idx) => {
                csv += `Table ${idx + 1}\n`;
                Array.from(table.rows).forEach(row => {
                    csv += Array.from(row.cells).map(cell => cell.textContent.trim()).join(',') + '\n';
                });
                csv += '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dashboard.csv';
            a.click();
        }

        // Export Excel using SheetJS
        function exportExcel() {
            if (typeof XLSX === 'undefined') {
                alert('SheetJS not loaded, falling back to CSV');
                exportCSV();
                return;
            }
            const wb = XLSX.utils.book_new();
            document.querySelectorAll('table').forEach((table, idx) => {
                const ws = XLSX.utils.table_to_sheet(table);
                XLSX.utils.book_append_sheet(wb, ws, `Sheet${idx + 1}`);
            });
            XLSX.writeFile(wb, 'dashboard.xlsx');
        }

        // Print
        function printDashboard() {
            // Hide controls
            document.querySelector('.flex.justify-between').style.display = 'none';
            window.print();
            document.querySelector('.flex.justify-between').style.display = 'flex';
        }

        // Initial update
        updateTotals();

        // Accessibility: Keyboard navigation for editable cells
        document.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('editable') && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        });
    </script>
</body>
</html>
