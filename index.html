<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGX Minerals - Login</title>
    <style>
        /* (All previous CSS unchanged – only tiny additions below) */
        .location-status { margin-top:10px; text-align:center; font-size:14px; }
        .location-status.success { color:#64ff96; }
        .location-status.error   { color:#ff6464; }
        .location-status.waiting { color:#b0b0d0; }
        .retry-btn { margin-top:8px; padding:6px 12px; background:#64ff96; color:#1a1a2e; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
        .retry-btn:hover { background:#2ecc71; }
        .login-btn:disabled { background:#555; cursor:not-allowed; }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="container" id="loginPage">
        <div class="camera-section">
            <div class="camera-container">
                <video id="cameraPreview" autoplay></video>
                <div class="capture-overlay" id="captureOverlay">
                    <div class="capture-animation"></div>
                </div>
            </div>
            <div class="camera-info">Camera will capture your photo upon login</div>
            <div class="location-status waiting" id="locationStatus">Getting your location…</div>
            <button class="retry-btn" id="retryLocation" style="display:none;">Retry Location</button>
        </div>

        <div class="login-section">
            <div class="decoration"></div>
            <div class="decoration"></div>
            <h1 class="company-title">SGX MINERALS</h1>
            <p class="company-subtitle">Resource Management System</p>

            <form class="login-form" id="loginForm">
                <h2>Welcome Back</h2>
                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn" disabled>Login</button>
                <div class="forgot-password"><a href="#">Forgot Password?</a></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Page (unchanged) -->
    <div class="dashboard" id="dashboardPage">…</div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ---------- DOM ----------
            const loginPage      = document.getElementById('loginPage');
            const dashboardPage  = document.getElementById('dashboardPage');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const logoutBtn      = document.getElementById('logoutBtn');
            const usernameInput  = document.getElementById('username');
            const passwordInput  = document.getElementById('password');
            const loginForm      = document.getElementById('loginForm');
            const loginBtn       = document.getElementById('loginBtn');
            const cameraPreview  = document.getElementById('cameraPreview');
            const captureOverlay = document.getElementById('captureOverlay');
            const capturedPhoto  = document.getElementById('capturedPhoto');
            const loginDetails   = document.getElementById('loginDetails');
            const locationStatus = document.getElementById('locationStatus');
            const locationNameEl = document.getElementById('locationName');
            const retryBtn       = document.getElementById('retryLocation');

            // ---------- STATE ----------
            let currentStream = null;
            let isCameraActive = false;
            let userLocation = null;          // will hold REAL coordinates only
            let locationAcquired = false;     // flag for login enable

            // ---------- EMPLOYEE DB ----------
            const employees = {
                'sgxminerals': { password: 'admin123', name: 'Alex Johnson', role: 'Operations Manager' },
                'jdoe':        { password: 'mineral2023', name: 'Jane Doe', role: 'Geologist' },
                'rsmith':      { password: 'extraction22', name: 'Robert Smith', role: 'Field Supervisor' }
            };

            // Pre‑fill demo
            usernameInput.value = 'sgxminerals';
            passwordInput.value = 'admin123';

            // ---------- CAMERA ----------
            function startCamera() {
                if (currentStream) stopCamera();
                navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 } }, audio: false })
                    .then(stream => { currentStream = stream; cameraPreview.srcObject = stream; isCameraActive = true; })
                    .catch(err => { console.error(err); alert('Camera access denied.'); });
            }
            function stopCamera() {
                if (currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; isCameraActive = false; }
            }

            // ---------- LOCATION ----------
            function requestLocation() {
                locationStatus.textContent = 'Getting your location…';
                locationStatus.className = 'location-status waiting';
                retryBtn.style.display = 'none';
                locationAcquired = false;
                loginBtn.disabled = true;

                if (!navigator.geolocation) {
                    locationFailed('Geolocation not supported by your browser.');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    pos => {
                        userLocation = {
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude,
                            acc: pos.coords.accuracy
                        };
                        locationAcquired = true;
                        loginBtn.disabled = false;
                        locationStatus.textContent = 'Location captured';
                        locationStatus.className = 'location-status success';
                        reverseGeocode(userLocation.lat, userLocation.lon);
                    },
                    err => {
                        console.error(err);
                        let msg = '';
                        switch (err.code) {
                            case err.PERMISSION_DENIED: msg = 'Location permission denied.'; break;
                            case err.POSITION_UNAVAILABLE: msg = 'Location information unavailable.'; break;
                            case err.TIMEOUT: msg = 'Location request timed out.'; break;
                            default: msg = 'Failed to get location.'; break;
                        }
                        locationFailed(msg);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            }

            function locationFailed(message) {
                userLocation = null;
                locationAcquired = false;
                loginBtn.disabled = true;
                locationStatus.textContent = message;
                locationStatus.className = 'location-status error';
                retryBtn.style.display = 'inline-block';
                locationNameEl.textContent = '';
            }

            // ---------- REVERSE GEOCODE ----------
            async function reverseGeocode(lat, lon) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                    const data = await res.json();
                    const address = data.display_name || `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    locationNameEl.textContent = `Location: ${address}`;
                } catch (e) {
                    console.error(e);
                    locationNameEl.textContent = `Location: ${lat.toFixed(6)}, ${lon.toFixed(6)} (geocoding failed)`;
                }
            }

            // ---------- CAPTURE ----------
            async function captureImage() {
                if (!isCameraActive) return null;
                captureOverlay.classList.add('active');
                await new Promise(r => setTimeout(r, 1000));
                const canvas = document.createElement('canvas');
                canvas.width = cameraPreview.videoWidth;
                canvas.height = cameraPreview.videoHeight;
                canvas.getContext('2d').drawImage(cameraPreview, 0, 0);
                const dataUrl = canvas.toDataURL('image/jpeg');
                captureOverlay.classList.remove('active');
                return dataUrl;
            }

            // ---------- LOGIN ----------
            async function loginSuccess(name) {
                const photo = await captureImage();
                loginPage.style.display = 'none';
                dashboardPage.style.display = 'block';
                welcomeMessage.textContent = `Welcome, ${name}!`;
                if (photo) capturedPhoto.src = photo;

                const now = new Date();
                const coordText = userLocation ? `${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}` : 'N/A';
                loginDetails.innerHTML = `
                    <p><strong>User:</strong> ${name}</p>
                    <p><strong>Login Time:</strong> ${now.toLocaleString()}</p>
                    <p><strong>Coordinates:</strong> ${coordText}</p>
                    <p><strong>Accuracy:</strong> ${userLocation ? userLocation.acc + ' m' : 'N/A'}</p>
                `;
            }

            // ---------- LOGOUT ----------
            function logout() {
                loginPage.style.display = 'flex';
                dashboardPage.style.display = 'none';
                loginForm.reset();
                usernameInput.value = 'sgxminerals';
                passwordInput.value = 'admin123';
                capturedPhoto.src = '';
                loginDetails.innerHTML = '';
                locationNameEl.textContent = '';
                // reset location UI
                locationStatus.textContent = 'Getting your location…';
                locationStatus.className = 'location-status waiting';
                retryBtn.style.display = 'none';
                loginBtn.disabled = true;
                startCamera();
                requestLocation();
            }

            // ---------- EVENT LISTENERS ----------
            loginForm.addEventListener('submit', async e => {
                e.preventDefault();
                if (!locationAcquired) {
                    alert('Please wait for your location to be acquired before logging in.');
                    return;
                }
                const u = usernameInput.value.trim();
                const p = passwordInput.value;
                if (employees[u] && employees[u].password === p) {
                    await loginSuccess(employees[u].name);
                } else {
                    alert('Invalid credentials.\nHint: sgxminerals / admin123');
                }
            });

            logoutBtn.addEventListener('click', logout);
            retryBtn.addEventListener('click', requestLocation);

            // Glow effect on inputs
            [usernameInput, passwordInput].forEach(i => {
                i.addEventListener('focus', () => loginForm.classList.add('glow'));
                i.addEventListener('blur', () => {
                    if (!usernameInput.matches(':focus') && !passwordInput.matches(':focus')) {
                        loginForm.classList.remove('glow');
                    }
                });
            });

            // ---------- INITIALISE ----------
            startCamera();
            requestLocation();   // <-- only real location, no default fallback
        });
    </script>
</body>
</html>
